/**
 * @file
 * CKEditor Comment - v1.0.4169
 * A plugin for supporting inline commenting in CKEditor.
 *
 * Homepage: https://github.com/tag1consulting/ckeditor_comments
 * Author: Mark Carver (https://drupal.org/user/501638)
 * Last build: 2013-12-04 1:05:42 AM MST
 */
CKEDITOR.dtd.comments=1,CKEDITOR.dtd.comment=1;var $nonEditable=CKEDITOR.dtd.$nonEditable||{};$nonEditable.comments=1,CKEDITOR.dtd.$nonEditable=$nonEditable;var $nonBodyContent=CKEDITOR.dtd.$nonBodyContent||{};$nonBodyContent.comments=1,CKEDITOR.dtd.$nonBodyContent=$nonBodyContent;var $inline=CKEDITOR.dtd.$inline||{};$inline.comment=1,CKEDITOR.dtd.$inline=$inline;var $editable=CKEDITOR.dtd.$editable||{};$editable.comment=1,$editable.span=1,CKEDITOR.dtd.$editable=$editable,CKEDITOR.plugins.add("comments",{init:function(a){window.CKEDITOR_COMMENTS_PLUGIN_PATH=this.path,a.Comments=new CKEDITOR.Comments(a),a.Comments.enabled&&(a.widgets.add("comment",CKEDITOR.CommentWidgetDefinition(a)),a.addCommand("comment_add",{modes:{wysiwyg:1},exec:function(){var b=rangy.getSelection(a.document.$);b.isCollapsed&&(b.expand("word"),b.refresh()),b.trim();var c=b.toHtml();if(c.length){var d=new CKEDITOR.dom.element("comment");d.setHtml(c),a.insertElement(d);var e=a.widgets.initOn(d,"comment",{content:c});if(!e.comment){var f=a.Comments.subclass(CKEDITOR.Comment,{inlineElement:d});f.widget=e,e.comment=f}a.widgets.focused&&a.widgets.focused!==e&&a.widgets.focused.setFocused(!1).setSelected(!1),e.focus(),0===e.comment.cid&&e.comment.edit()}}}),a.ui.addButton("comment",{label:"Comment",icon:window.CKEDITOR_COMMENTS_PLUGIN_PATH+"comment.png",command:"comment_add"}),CKEDITOR.dialog.add("comment",function(){return{title:"Edit comment contents",minWidth:400,minHeight:50,contents:[{id:"info",elements:[{id:"content",type:"textarea",width:"100%",rows:10,setup:function(a){this.setValue(a.data.content)},commit:function(a){a.setData("content",this.getValue())},validate:function(){return this.getValue().length<1?(window.alert("You must provide at least 1 character of valid text."),!1):void 0}}]}]}}),a.on("instanceReady",function(){a.Comments.init(),a.on("getData",function(a){var b=new CKEDITOR.dom.element("div");b.setHtml(a.data.dataValue);for(var c=b.find("comment"),d=0;d<c.count();d++){var e=c.getItem(d);e.removeAttributes(["style","class"])}a.data.dataValue=b.getHtml()}),a.on("mode",function(a){var b=a.editor;"wysiwyg"===b.mode?b.Comments.init():"source"===b.mode&&(b.Comments._initialized=!1)})}))}}),function(a){CKEDITOR&&!CKEDITOR.Comments&&(CKEDITOR.Comments=function(b){return this._initialized=!1,this._temporaryCid=0,this.ajax=this.subclass(CKEDITOR.CommentAjax),this.comments={},this.editor=b||{},this.data=this.editor.name?a.extend(!0,{commentsEnabled:!1},a("#"+this.editor.name).data()):{},this.enabled=this.data.commentsEnabled||!1,this.activeComment=!1,this.loaded=!1,this.removeQueue=[],this.saveQueue=[],this.sidebar=!1,this.users={},this},CKEDITOR.Comments.prototype={init:function(){var b=this;if(b.enabled&&!b._initialized){b._initialized=!0,this.sidebar=this.subclass(CKEDITOR.CommentSidebar);var c=new CKEDITOR.dom.element("link");a(c.$).on("load",function(){b.sidebar.containerResize()}),c.setAttributes({type:"text/css",rel:"stylesheet",href:window.CKEDITOR_COMMENTS_PLUGIN_PATH+"plugin.css",media:"screen"}).appendTo(b.editor.document.getHead()),this.sidebar.createContainer();for(var d=b.editor.document.find("comment"),e=0;e<d.count();e++){var f=d.getItem(e);b.editor.getSelection().selectElement(f);var g=rangy.getSelection(b.editor.document.$).toHtml();b.editor.widgets.initOn(f,"comment",{content:g})}}},closestComment:function(){var b=this,c=b.editor.getSelection(),d=c?c.getStartElement():!1,e=a();return d&&(e=a(d.$).closest("comment"),e.length||(e=a(d.$).find("comment:first")),e.length||(e=a(d.$).parent().find("comment:first"))),d&&e.length||(e=a(b.editor.document.$).find("comment:first")),e.length&&e.get(0)._&&e.get(0)._ instanceof CKEDITOR.Comments?e.get(0)._:!1},arrangeComments:function(b){var c=this;if(b=b||c.activeComment||c.closestComment(),b&&b.sidebarElement.length){var d,e,f,g,h=b.sidebarElement.prevAll("comment").toArray(),i=b.sidebarElement.nextAll("comment").toArray();d=f=b.sidebarElement.get(0).newTop=b.findTop(),c.sidebar.container.find("> comment").stop(!0);var j=function(){this._.sidebarElement.animate({top:this.newTop+"px"}),delete this.newTop};for(b.sidebarElement.queue("arrangeComments",j);h.length||i.length;)h.length&&(e=h.splice(0,1)[0],d-=a(e).outerHeight(!1)+10,e.newTop=d,a(e).queue("arrangeComments",j)),i.length&&(g=i.splice(0,1)[0],f+=a(g).outerHeight(!1)+10,g.newTop=f,a(g).queue("arrangeComments",j));c.sidebar.container.find("> comment").dequeue("arrangeComments")}},getTemporaryCid:function(){return this._temporaryCid=this._temporaryCid-1,this._temporaryCid},subclass:function(a){var b,c=Array.prototype.slice.call(arguments,1),d=a.prototype||{},e=this,f={};for(b in e)a.hasOwnProperty(b)||e[b]instanceof Object?f[b]=e[b]:!function(){var a=b;Object.defineProperty(f,b,{configurable:!0,enumerable:!0,get:function(){return e[a]},set:function(b){e[a]=b}})}();a.prototype=f;for(b in d)a.prototype[b]=d[b];var g=a.apply(new a,c);return a.prototype=d,g}})}(jQuery),function(a){CKEDITOR&&CKEDITOR.Comments&&!CKEDITOR.Comment&&(CKEDITOR.Comment=function(b){var c=this;c._destroying=!1,c._editing=!1,c._new=!1,c._saving=!1;var d=0;c.changed=d,Object.defineProperty(c,"changed",{configurable:!0,enumerable:!0,get:function(){return d},set:function(a){var b=d;"number"!=typeof a&&(a=parseInt(a,10)||0),b!==a&&(d=a);var e=c.sidebarElement.find("time");if(d&&e.length){var f=new Date(1e3*d);e.length&&jQuery.timeago?e.timeago("update",f):e.html(f.toLocaleDateString())}else e.html("")}}),c.character_range=[];var e=0;c.cid=e,Object.defineProperty(c,"cid",{configurable:!0,enumerable:!0,get:function(){return e},set:function(a){var b=e;"number"!=typeof a&&(a=parseInt(a,10)||0),b!==a&&(e=a,c.inlineElement instanceof jQuery&&c.inlineElement.length&&(c.inlineElement.attr("data-cid",e),e&&(c.comments[e]=c),b&&c.comments[b]&&delete c.comments[b]))}}),c.content="";var f=a();c.inlineElement=f,Object.defineProperty(c,"inlineElement",{configurable:!0,enumerable:!0,get:function(){return f},set:function(b){var d=f;if(d!==b&&(b instanceof Node&&(b=a(b)),b instanceof CKEDITOR.dom.element&&(b=a(b.$)),b instanceof jQuery&&b.length?b.get(0)._=c:b=a(),f=b,f.length)){var e=f.data("cid");e&&(c.cid=e),c.sidebarElement=a('<comment><div class="color"></div><header></header><section></section><footer></footer></comment>').addClass("cke-comment").attr("data-widget-wrapper","true").css("top",c.findTop()+"px").on("click",function(b){c.editor.widgets.selected.length&&c.editor.widgets.selected[0].comment!==c&&a(b.target).not(":input").length&&c.widget.focus()}).appendTo(c.sidebar.container),c.sidebar.sort(),c.assignUser(),c.arrangeComments()}}}),c.name=!1,c.picture=!1;var g=a();c.sidebarElement=g,Object.defineProperty(c,"sidebarElement",{configurable:!0,enumerable:!0,get:function(){return g},set:function(b){b instanceof jQuery&&b.length?(b.get(0)._=c,b.find("section").html(c.content)):b=a(),g=b}}),c.uid=0,b=b||{};for(var h in b)b.hasOwnProperty(h)&&c.hasOwnProperty(h)&&(c[h]=b[h]);return c},CKEDITOR.Comment.prototype={destroy:function(){this._destroying=!0,this.editor.getSelection().selectElement(this.widget.wrapper),this.editor.widgets.del(this.widget)},edit:function(){var b=this;if(!b._editing){b._editing=!0;var c=b.sidebarElement.find("section");b.content=c.html();var d=a("<textarea/>").val(b.content);c.html(d),d.focus(),a("<button/>").text("Save").addClass("primary").appendTo(c).bind("click",function(){b.content=d.val(),b.save(function(){c.html(b.content),b._editing=!1,b.arrangeComments()})}),a("<button/>").text("Cancel").appendTo(c).bind("click",function(){b._editing=!1,0===b.cid?b.destroy():(c.html(b.content),b.arrangeComments())}),b.arrangeComments(b)}},assignUser:function(){function b(a,b){return parseInt(Math.random()*(b-a+1),10)+a}function c(){var a=b(0,360),c=b(20,80),d=b(50,70);return"hsl("+a+","+c+"%,"+d+"%)"}var d=this;d.uid||(d.uid=Drupal.settings.ckeditor_comment.currentUser.uid,d.name=Drupal.settings.ckeditor_comment.currentUser.name,d.picture=Drupal.settings.ckeditor_comment.currentUser.picture),d.users[d.uid]||(d.users[d.uid]={uid:d.uid,name:d.name,picture:d.picture});var e=d.users[d.uid];e.color||(e.color=c()),d.inlineElement.css("borderColor",e.color),d.sidebarElement.find(".color").css("backgroundColor",e.color);var f=d.sidebarElement.find("header");f.append(e.picture),a("<span/>").attr("rel","author").addClass("name").html(e.name).appendTo(f);var g=a("<time/>").appendTo(f);if(d.changed){var h=new Date(1e3*d.changed);g.attr("datetime",h.toISOString()).html(h.toLocaleString()),a.timeago&&g.timeago()}},findTop:function(){var a=this;return a.inlineElement.length?a.inlineElement.offset().top-a.inlineElement.outerHeight(!1)/2:0},resolve:function(){},save:function(a){this.cid=this.getTemporaryCid(),"function"==typeof a&&a()},set:function(a,b){var c=this;if("string"==typeof a&&"undefined"!=typeof c[a]&&"undefined"!=typeof b)c[a]=b;else if("object"==typeof a)for(var d in a)"undefined"!=typeof c[d]&&(c[d]=a[d])},updateCharacterRange:function(){var a,b=rangy.getSelection(this.editor.document.$),c=this.editor.getSelection();c&&(a=c.getRanges(),c.lock()),b.selectAllChildren(this.inlineElement.get(0));var d=b.saveCharacterRanges();JSON.stringify(d)!==JSON.stringify(this.character_range)&&(this.character_range=d),c&&(c.selectRanges(a),c.unlock())}})}(jQuery),function(a){CKEDITOR&&CKEDITOR.Comments&&!CKEDITOR.CommentAjax&&(CKEDITOR.CommentAjax=function(){return this},CKEDITOR.CommentAjax.prototype={ajax:function(b,c){c=c||{};var d={url:Drupal.settings.basePath+"ajax/ckeditor/comment",type:"POST",dataType:"json",data:this.data};c=a.extend(!0,d,c),c.data.action=b,a.ajax(c)},loadComments:function(){var b=this;if(!b.loaded){b.editor.setReadOnly(!0);var c=a('<div class="loading">Please wait...</div>');b.sidebar.container.append(c),a(b.editor.document.$).find("body comment").each(function(){var c=a(this),d=a.extend(!0,{inlineElement:c},c.data()),e=b.subclass(CKEDITOR.Comment,d);e.cid||e.remove()}),b.ajax("comment_load",{data:{comments:b.data.cids},success:function(a){b.template=a.template;for(var c=0;c<a.comments.length;c++){var d=b.subclass(CKEDITOR.Comment,a.comments[c]);d.cid&&!b.comments[d.cid]&&b.createComment(d)}},complete:function(){c.remove(),b.editor.setReadOnly(!1)}}),b.loaded=!0}}})}(jQuery),function(a){CKEDITOR&&CKEDITOR.Comments&&!CKEDITOR.CommentSidebar&&(CKEDITOR.CommentSidebar=function(){return this.container=a(),this},CKEDITOR.CommentSidebar.prototype={createContainer:function(){if(!this.container.length){this.container=a("<comments/>").addClass("cke-comments-sidebar").attr("data-widget-wrapper","true").appendTo(a(this.editor.document.$).find("html"));var b=this;a(b.editor.document.getWindow().$).on("resize.cke-comments-sidebar",function(){window.console.log("window resize"),b.containerResize()})}},containerResize:function(){var b=a(this.editor.document.$),c=b.find("body");this.container.css("left",(b.find("html").width()-c.outerWidth(!1))/2+c.outerWidth(!1)+20)},sort:function(){var b,c=a(this.editor.document.$).find("body comment");for(b=0;b<c.length;b++)c[b]._&&c[b]._.sidebarElement.get(0)&&(c[b]._.sidebarElement.get(0).commentIndex=b,c[b]._.updateCharacterRange());var d=this.container.find("> comment");d.length&&(d.sort(function(a,b){return a.commentIndex>b.commentIndex?1:a.commentIndex<b.commentIndex?-1:0}),this.container.append(d))}})}(jQuery),function(a){CKEDITOR&&CKEDITOR.Comments&&!CKEDITOR.CommentWidget&&(CKEDITOR.CommentWidgetDefinition=function(a){return{defaults:function(){var b=rangy.getSelection(a.document.$);return b.isCollapsed&&(b.expand("word"),b.refresh()),b.trim(),{content:b.toHtml()}},editables:{content:{selector:".comment-content"}},parts:{content:".comment-content"},requiredContent:"comment",template:'<comment><span class="comment-content">{content}</span></comment>',init:function(){return a.Comments._initialized?(this.element.getDocument().equals(a.document)||this.data.content.length?(this.data.content.length||this.setData("content",this.element.getHtml()),a.Comments.subclass(CKEDITOR.CommentWidget,this)):a.widgets.del(this),void 0):(a.widgets.destroy(this),void 0)},upcast:function(a){return"comment"===a.name}}},CKEDITOR.CommentWidget=function(a){var b=this;return b.comment={},a?(a.on("blur",b.blur),a.on("data",b.data),a.on("destroy",b.destroy),a.on("focus",b.focus),a.on("ready",b.ready),b.widget=a,b):b},CKEDITOR.CommentWidget.prototype={blur:function(a){var b=a.sender;return b.comment._editing?(a.stop(),void 0):(b.comment._destroying||(b.comment.inlineElement.removeClass("active"),b.comment.sidebarElement.removeClass("active"),0!==b.comment.cid||b.comment._saving||b.comment.destroy()),void 0)},data:function(a){var b=a.sender;b.element.setHtml(b.data.content)},destroy:function(a){var b=a.sender;b.editor.undoManager.lock(!0),b.comment.sidebarElement.remove(),b.editor.insertHtml(b.data.content),b.editor.undoManager.unlock()},focus:function(a){var b=a.sender;b.comment._destroying||(b.comment.inlineElement.addClass("active"),b.comment.sidebarElement.addClass("active"),b.comment.arrangeComments())},ready:function(b){var c=b.sender;if(c.dialog="comment",!c.comment){var d=c.editor.Comments.subclass(CKEDITOR.Comment,{inlineElement:a(c.element.$)});d.widget=c,c.comment=d}}})}(jQuery);