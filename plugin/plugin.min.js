/**
 * @file
 * CKEditor Comment - v1.0.4015
 * A plugin for supporting inline commenting in CKEditor.
 *
 * Homepage: https://github.com/tag1consulting/ckeditor_comments
 * Author: Mark Carver (https://drupal.org/user/501638)
 * Last build: 2013-12-03 1:31:31 PM MST
 */
CKEDITOR.dtd.comments=1,CKEDITOR.dtd.comment=1;var $nonEditable=CKEDITOR.dtd.$nonEditable||{};$nonEditable.comments=1,CKEDITOR.dtd.$nonEditable=$nonEditable;var $nonBodyContent=CKEDITOR.dtd.$nonBodyContent||{};$nonBodyContent.comments=1,CKEDITOR.dtd.$nonBodyContent=$nonBodyContent;var $inline=CKEDITOR.dtd.$inline||{};$inline.comment=1,CKEDITOR.dtd.$inline=$inline;var $editable=CKEDITOR.dtd.$editable||{};$editable.comment=1,$editable.span=1,CKEDITOR.dtd.$editable=$editable,CKEDITOR.plugins.add("comments",{init:function(a){window.CKEDITOR_COMMENTS_PLUGIN_PATH=this.path,a.Comments=new CKEDITOR.Comments(a),a.Comments.enabled&&(a.ui.addButton("comment",{label:"Comment",icon:window.CKEDITOR_COMMENTS_PLUGIN_PATH+"comment.png",command:"comment"}),CKEDITOR.dialog.add("comment",function(){return{title:"Edit comment contents",minWidth:400,minHeight:50,contents:[{id:"info",elements:[{id:"content",type:"textarea",width:"100%",rows:10,setup:function(a){this.setValue(a.data.content)},commit:function(a){a.setData("content",this.getValue())},validate:function(){return this.getValue().length<1?(window.alert("You must provide at least 1 character of valid text."),!1):void 0}}]}]}}),a.on("instanceReady",function(){a.Comments.init()}))}}),function(a){CKEDITOR&&!CKEDITOR.Comments&&(CKEDITOR.Comments=function(b){return this._initialized=!1,this.comments={},this.tempCid=0,this.editor=b||{},this.data=this.editor.name?a.extend(!0,{commentsEnabled:!1},a("#"+this.editor.name).data()):{},this.enabled=this.data.commentsEnabled||!1,this.activeComment=!1,this.loaded=!1,this.removeQueue=[],this.saveQueue=[],this.users={},this},CKEDITOR.Comments.prototype={init:function(){if(this.enabled&&!this._initialized){this._initialized=!0;var b=this;this.sidebar=this.subclass(CKEDITOR.CommentSidebar),this.sidebar.createContainer(),this.ajax=this.subclass(CKEDITOR.CommentAjax),a("<link/>").attr({type:"text/css",rel:"stylesheet",href:window.CKEDITOR_COMMENTS_PLUGIN_PATH+"plugin.css",media:"screen"}).on("load",function(){b.sidebar.containerResize()}).appendTo(a(this.editor.document.$).find("head")),b.editor.widgets.add("comment",{button:"Create a comment",defaults:function(){var a=rangy.getSelection(b.editor.document.$);return a.isCollapsed&&(a.expand("word"),a.refresh()),{content:a.toHtml()}},editables:{content:{selector:".cke-comment-content"}},parts:{content:".cke-comment-content"},requiredContent:"comment",template:'<comment><span class="cke-comment-content">{content}</span></comment>',init:function(){b.subclass(CKEDITOR.CommentWidget,this)},upcast:function(a){return"comment"===a.name}}),this.editor.on("mode",function(a){var b=a.editor;"wysiwyg"!==b.mode||b.Comments?"source"===b.mode&&b.Comments&&b.Comments instanceof CKEDITOR.Comments&&delete b.Comments:(b.Comments=new CKEDITOR.Comments(b),b.Comments.init())})}},closestComment:function(){var b=this,c=b.editor.getSelection(),d=c.getStartElement(),e=a();return d&&(e=a(d.$).closest("comment"),e.length||(e=a(d.$).find("comment:first")),e.length||(e=a(d.$).parent().find("comment:first"))),d&&e.length||(e=a(b.editor.document.$).find("comment:first")),e.length&&e.get(0)._&&e.get(0)._ instanceof CKEDITOR.Comments?e.get(0)._:!1},arrangeComments:function(b){var c=this;if(b=b||c.activeComment||c.closestComment(),b&&b.sidebarElement.length){var d,e,f,g,h=b.sidebarElement.prevAll("comment").toArray(),i=b.sidebarElement.nextAll("comment").toArray();d=f=b.sidebarElement.get(0).newTop=b.findTop(),c.sidebar.container.find("> comment").stop(!0);var j=function(){this._.sidebarElement.animate({top:this.newTop+"px"}),delete this.newTop};for(b.sidebarElement.queue("arrangeComments",j);h.length||i.length;)h.length&&(e=h.splice(0,1)[0],d-=a(e).outerHeight(!1)+10,e.newTop=d,a(e).queue("arrangeComments",j)),i.length&&(g=i.splice(0,1)[0],f+=a(g).outerHeight(!1)+10,g.newTop=f,a(g).queue("arrangeComments",j));c.sidebar.container.find("> comment").dequeue("arrangeComments")}},isolate:function(a){if(a=a||function(){},"function"==typeof a){var b=this.editor.readOnly;b&&this.editor.setReadOnly(!1);var c=rangy.getSelection(this.editor.document.$),d=c.saveCharacterRanges();a(c);var e=this;setTimeout(function(){c.restoreCharacterRanges(e.editor.document.$,d)},4),b&&this.editor.setReadOnly(!0)}},createComment:function(b,c){var d=this;b=b||{},c=c||!1,this.isolate(function(e){if(b.character_range?e.restoreCharacterRanges(d.editor.document.$,b.character_range):(e.isCollapsed&&(e.expand("word"),e.refresh()),b.character_range=e.saveCharacterRanges()),!b.inlineElement||!b.inlineElement.length){var f=a("<comment/>").html(e.toHtml());b.cid&&f.attr("data-cid",b.cid),d.editor.insertElement(new CKEDITOR.dom.element(f.get(0))),b.inlineElement=f}var g=b;g instanceof CKEDITOR.Comments||(g=d.subclass(CKEDITOR.Comment,b)),c&&g.activate(),g.cid||g.edit()})},subclass:function(a){var b,c=Array.prototype.slice.call(arguments,1),d=a.prototype||{},e=this,f={};for(b in e)a.hasOwnProperty(b)||e[b]instanceof Object?f[b]=e[b]:!function(){var a=b;Object.defineProperty(f,b,{configurable:!0,enumerable:!0,get:function(){return e[a]},set:function(b){e[a]=b}})}();a.prototype=f;for(b in d)a.prototype[b]=d[b];var g=a.apply(new a,c);return a.prototype=d,g}})}(jQuery),function(a){CKEDITOR&&CKEDITOR.Comments&&!CKEDITOR.Comment&&(CKEDITOR.Comment=function(b){var c=this;c._saving=!1,c._editing=!1,c._new=!1;var d=0;c.changed=d,Object.defineProperty(c,"changed",{configurable:!0,enumerable:!0,get:function(){return d},set:function(a){var b=d;"number"!=typeof a&&(a=parseInt(a,10)||0),b!==a&&(d=a);var e=c.sidebarElement.find("time");if(d&&e.length){var f=new Date(1e3*d);e.length&&jQuery.timeago?e.timeago("update",f):e.html(f.toLocaleDateString())}else e.html("")}}),c.character_range=[];var e=0;c.cid=e,Object.defineProperty(c,"cid",{configurable:!0,enumerable:!0,get:function(){return e},set:function(a){var b=e;"number"!=typeof a&&(a=parseInt(a,10)||0),b!==a&&(e=a,c.inlineElement instanceof jQuery&&c.inlineElement.length&&(c.inlineElement.attr("data-cid",e),e&&(c.comments[e]=c),b&&c.comments[b]&&delete c.comments[b]))}}),c.content="";var f=a();c.inlineElement=f,Object.defineProperty(c,"inlineElement",{configurable:!0,enumerable:!0,get:function(){return f},set:function(b){var d=f;d!==b&&b instanceof jQuery&&b.length?b.get(0)._=c:b=a(),f=b,f.length&&(c.sidebarElement=a('<comment><div class="color"></div><header></header><section></section><footer></footer></comment>').addClass("cke-comment").attr("data-widget-wrapper","true").css("top",c.findTop()+"px").on("click",function(){c.activate()}).appendTo(c.sidebar.container),c.sidebar.sort(),c.assignUser(),c.arrangeComments())}}),c.name=!1,c.picture=!1;var g=a();c.sidebarElement=g,Object.defineProperty(c,"sidebarElement",{configurable:!0,enumerable:!0,get:function(){return g},set:function(b){b instanceof jQuery&&b.length?(b.get(0)._=c,b.find("section").html(c.content)):b=a(),g=b}}),c.uid=0,b=b||{};for(var h in b)b.hasOwnProperty(h)&&c.hasOwnProperty(h)&&(c[h]=b[h]);return c},CKEDITOR.Comment.prototype={edit:function(){var b=this;if(!b._editing){b.edit=!0;var c=b.sidebarElement.find("section");b.content=c.html();var d=a("<textarea/>").val(b.content);c.html(d),d.focus(),a("<button/>").text("Save").addClass("primary").appendTo(c).bind("click",function(){b.content=d.val(),b.save(function(){c.html(b.content),b._editing=!1,b.arrangeComments()})}),a("<button/>").text("Cancel").appendTo(c).bind("click",function(){b._editing=!1,b.cid?(c.html(b.content),b.arrangeComments()):b.widget.destroy()}),b.arrangeComments(b)}},assignUser:function(){function b(a,b){return parseInt(Math.random()*(b-a+1),10)+a}function c(){var a=b(0,360),c=b(20,80),d=b(50,70);return"hsl("+a+","+c+"%,"+d+"%)"}var d=this;d.uid||(d.uid=Drupal.settings.ckeditor_comment.currentUser.uid,d.name=Drupal.settings.ckeditor_comment.currentUser.name,d.picture=Drupal.settings.ckeditor_comment.currentUser.picture),d.users[d.uid]||(d.users[d.uid]={uid:d.uid,name:d.name,picture:d.picture});var e=d.users[d.uid];e.color||(e.color=c()),d.inlineElement.css("borderColor",e.color),d.sidebarElement.find(".color").css("backgroundColor",e.color);var f=d.sidebarElement.find("header");f.append(e.picture),a("<span/>").attr("rel","author").addClass("name").html(e.name).appendTo(f);var g=a("<time/>").appendTo(f);if(d.changed){var h=new Date(1e3*d.changed);g.attr("datetime",h.toISOString()).html(h.toLocaleString()),a.timeago&&g.timeago()}},deactive:function(){var a=this;a.activeComment===a&&(a.activeComment=!1),a.inlineElement.removeClass("active"),a.sidebarElement.removeClass("active")},activate:function(){var a=this;a.activeComment&&a.activeComment!==a&&a.activeComment.deactive(),a.activeComment=a,a.inlineElement.addClass("active"),a.sidebarElement.addClass("active"),a.arrangeComments()},findTop:function(){var a=this;return a.inlineElement.length?a.inlineElement.offset().top-a.inlineElement.outerHeight(!1)/2:0},resolve:function(){},save:function(a){"function"==typeof a&&a()},set:function(a,b){var c=this;if("string"==typeof a&&"undefined"!=typeof c[a]&&"undefined"!=typeof b)c[a]=b;else if("object"==typeof a)for(var d in a)"undefined"!=typeof c[d]&&(c[d]=a[d])},updateCharacterRange:function(){var a=rangy.getSelection(this.editor.document.$),b=this.editor.getSelection().getRanges();this.editor.getSelection().lock(),a.selectAllChildren(this.inlineElement.get(0));var c=a.saveCharacterRanges();JSON.stringify(c)!==JSON.stringify(this.character_range)&&(this.character_range=c),this.editor.getSelection().selectRanges(b),this.editor.getSelection().unlock()}})}(jQuery),function(a){CKEDITOR&&CKEDITOR.Comments&&!CKEDITOR.CommentAjax&&(CKEDITOR.CommentAjax=function(){return this},CKEDITOR.CommentAjax.prototype={ajax:function(b,c){c=c||{};var d={url:Drupal.settings.basePath+"ajax/ckeditor/comment",type:"POST",dataType:"json",data:this.data};c=a.extend(!0,d,c),c.data.action=b,a.ajax(c)},loadComments:function(){var b=this;if(!b.loaded){b.editor.setReadOnly(!0);var c=a('<div class="loading">Please wait...</div>');b.sidebar.container.append(c),a(b.editor.document.$).find("body comment").each(function(){var c=a(this),d=a.extend(!0,{inlineElement:c},c.data()),e=b.subclass(CKEDITOR.Comment,d);e.cid||e.remove()}),b.ajax("comment_load",{data:{comments:b.data.cids},success:function(a){b.template=a.template;for(var c=0;c<a.comments.length;c++){var d=b.subclass(CKEDITOR.Comment,a.comments[c]);d.cid&&!b.comments[d.cid]&&b.createComment(d)}},complete:function(){c.remove(),b.editor.setReadOnly(!1)}}),b.loaded=!0}}})}(jQuery),function(a){CKEDITOR&&CKEDITOR.Comments&&!CKEDITOR.CommentSidebar&&(CKEDITOR.CommentSidebar=function(){return this.container=a(),this},CKEDITOR.CommentSidebar.prototype={createContainer:function(){if(!this.container.length){this.container=a("<comments/>").addClass("cke-comments-sidebar").attr("data-widget-wrapper","true").appendTo(a(this.editor.document.$).find("html"));var b=this;a(b.editor.document.getWindow().$).on("resize.cke-comments-sidebar",function(){window.console.log("window resize"),b.containerResize()})}},containerResize:function(){var b=a(this.editor.document.$),c=b.find("body");this.container.css("left",(b.find("html").width()-c.outerWidth(!1))/2+c.outerWidth(!1)+20)},sort:function(){var b,c=a(this.editor.document.$).find("body comment");for(b=0;b<c.length;b++)c[b]._&&c[b]._.sidebarElement.get(0)&&(c[b]._.sidebarElement.get(0).commentIndex=b,c[b]._.updateCharacterRange());var d=this.container.find("> comment");d.length&&(d.sort(function(a,b){return a.commentIndex>b.commentIndex?1:a.commentIndex<b.commentIndex?-1:0}),this.container.append(d))}})}(jQuery),function(a){CKEDITOR&&CKEDITOR.Comments&&!CKEDITOR.CommentWidget&&(CKEDITOR.CommentWidget=function(a){var b=this;return b.comment={},a?(a.on("data",function(){b.data(this)}),a.on("deselect",function(){b.deselect(this)}),a.on("destroy",function(){b.destroy(this)}),a.on("ready",function(){b.ready(this)}),a.on("select",function(){b.select(this)}),b.widget=a,b):b},CKEDITOR.CommentWidget.prototype={data:function(a){a.element.setHtml(a.data.content)},deselect:function(a){a.comment.deactive()},destroy:function(a){this.editor.undoManager.lock(),a.comment.sidebarElement.remove(),this.editor.insertHtml(a.data.content),this.editor.undoManager.unlock()},ready:function(b){b.dialog="comment";var c=this.subclass(CKEDITOR.Comment,{inlineElement:a(b.element.$)});c.widget=b,c.activate(),c.cid||c.edit(),b.comment=c},select:function(a){a.comment.activate()}})}(jQuery);