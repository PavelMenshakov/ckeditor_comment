/**
 * @file
 * CKEditor Comment - v1.0.3329
 * A plugin for supporting inline commenting in CKEditor.
 *
 * Homepage: https://github.com/tag1consulting/ckeditor_comments
 * Author: Mark Carver (https://drupal.org/user/501638)
 * Last build: 2013-11-23 9:17:37 AM CST
 */
!function(a){"use strict";CKEDITOR.Comment=function(b,c){var d=this;d._=b,d._saving=!1,d._editing=!1,d._new=!1;var e=0;d.changed=e,Object.defineProperty(d,"changed",{configurable:!0,enumerable:!0,get:function(){return e},set:function(a){var b=e;"number"!=typeof a&&(a=parseInt(a,10)||0),b!==a&&(e=a);var c=d.sidebarElement.find("time");if(e&&c.length){var f=new Date(1e3*e);c.length&&jQuery.timeago?c.timeago("update",f):c.html(f.toLocaleDateString())}else c.html("")}}),d.character_range=[];var f=0;d.cid=f,Object.defineProperty(d,"cid",{configurable:!0,enumerable:!0,get:function(){return f},set:function(a){var b=f;"number"!=typeof a&&(a=parseInt(a,10)||0),b!==a&&(f=a,d.inlineElement instanceof jQuery&&d.inlineElement.length&&(d.inlineElement.attr("data-cid",f),f&&(d._.comments[f]=d),b&&d._.comments[b]&&delete d._.comments[b]))}}),d.content="";var g=a();d.inlineElement=g,Object.defineProperty(d,"inlineElement",{configurable:!0,enumerable:!0,get:function(){return g},set:function(b){var c=g;c!==b&&b instanceof jQuery&&b.length?b.get(0)._=d:b=a(),g=b,g.length&&(d.__createSidebarElement(),d.assignUser(),d._.arrangeComments())}}),d.name=!1,d.picture=!1;var h=a();d.sidebarElement=h,Object.defineProperty(d,"sidebarElement",{configurable:!0,enumerable:!0,get:function(){return h},set:function(b){b instanceof jQuery&&b.length?(b.get(0)._=d,b.find("section").html(d.content)):b=a(),h=b}}),d.uid=0,c=c||{};for(var i in c)c.hasOwnProperty(i)&&d.hasOwnProperty(i)&&(d[i]=c[i]);return d},CKEDITOR.Comment.prototype.__createSidebarElement=function(){var b=this;b.sidebarElement.length||(b.sidebarElement=a('<comment><div class="color"></div><header></header><section></section><footer></footer></comment>').addClass("cke-comment").attr("data-widget-wrapper","true").css("top",b.findTop()+"px").on("click",function(){b.activate()}).appendTo(b._.sidebar),b._.sort())},CKEDITOR.Comment.prototype.remove=function(){var a=this;a.inlineElement.length&&a.inlineElement.contents().unwrap(),a.sidebarElement.length&&a.sidebarElement.remove(),a._.arrangeComments()},CKEDITOR.Comment.prototype.edit=function(){var b=this;if(!b._editing){b.edit=!0;var c=b.sidebarElement.find("section");b.content=c.html();var d=a("<textarea/>").val(b.content);c.html(d),d.focus(),a("<button/>").text("Save").addClass("primary").appendTo(c).bind("click",function(){b.content=d.val(),b.save(function(){c.html(b.content),b._editing=!1,b._.arrangeComments()})}),a("<button/>").text("Cancel").appendTo(c).bind("click",function(){b._editing=!1,b.cid?(c.html(b.content),b._.arrangeComments()):b.remove()}),b._.arrangeComments(b)}},CKEDITOR.Comment.prototype.assignUser=function(){function b(a,b){return parseInt(Math.random()*(b-a+1),10)+a}function c(){var a=b(0,360),c=b(20,80),d=b(50,70);return"hsl("+a+","+c+"%,"+d+"%)"}var d=this;d.uid||(d.uid=Drupal.settings.ckeditor_comment.currentUser.uid,d.name=Drupal.settings.ckeditor_comment.currentUser.name,d.picture=Drupal.settings.ckeditor_comment.currentUser.picture),d._.users[d.uid]||(d._.users[d.uid]={uid:d.uid,name:d.name,picture:d.picture});var e=d._.users[d.uid];e.color||(e.color=c()),d.inlineElement.css("borderColor",e.color),d.sidebarElement.find(".color").css("backgroundColor",e.color);var f=d.sidebarElement.find("header");f.append(e.picture),a("<span/>").attr("rel","author").addClass("name").html(e.name).appendTo(f);var g=a("<time/>").appendTo(f);if(d.changed){var h=new Date(1e3*d.changed);g.attr("datetime",h.toISOString()).html(h.toLocaleString()),a.timeago&&g.timeago()}},CKEDITOR.Comment.prototype.deactive=function(){var a=this;a._.activeComment===a&&(a._.activeComment=!1),a.cid||a._saving?(a.inlineElement.removeClass("active"),a.sidebarElement.removeClass("active")):a.remove()},CKEDITOR.Comment.prototype.activate=function(){var a=this;a._.activeComment&&a._.activeComment!==a&&a._.activeComment.deactive(),a._.activeComment=a,a.inlineElement.addClass("active"),a.sidebarElement.addClass("active"),a._.arrangeComments()},CKEDITOR.Comment.prototype.findTop=function(){var a=this;return a.inlineElement.length?a.inlineElement.position().top-a.inlineElement.outerHeight(!1)/2:0},CKEDITOR.Comment.prototype.resolve=function(){},CKEDITOR.Comment.prototype.save=function(a){var b=this;a=a||function(){},b._saving=!0,b._.ajax("comment_save",{data:{comments:[{cid:b.cid,character_range:b.character_range,ckeditor_comment_body:b.content}]},success:function(c){b.cid=c.comments[0].cid,b.name=c.comments[0].name,b.picture=c.comments[0].picture,b.uid=c.comments[0].uid,b.content=c.comments[0].content,b._saving=!1,a(c)}})},CKEDITOR.Comment.prototype.set=function(a,b){var c=this;if("string"==typeof a&&"undefined"!=typeof c[a]&&"undefined"!=typeof b)c[a]=b;else if("object"==typeof a)for(var d in a)"undefined"!=typeof c[d]&&(c[d]=a[d])},CKEDITOR.Comments=function(b){var c=this;return c._initialized=!1,c.comments={},c.tempCid=0,c.editor=b,c.data=a.extend(!0,{commentsEnabled:!1},a("#"+b.name).data()),c.enabled=c.data.commentsEnabled||!1,c.activeComment=!1,c.loaded=!1,c.removeQueue=[],c.saveQueue=[],c.sidebar=a(),c.users={},c},CKEDITOR.Comments.prototype={init:function(){var a=this;a._initialized||(a.createSidebar(),a.loadComments(),a.editor.on("selectionChange",a.selectionChange),a._initialized=!0)},selectionChange:function(a){var b=a.editor.comments;a.removeListener(),b.sort(),a.editor.on("selectionChange",b.selectionChange);var c=a.data.selection.getRanges()[0];if(window.console.log(c),window.console.log(c.startContainer.getParent().$),c.collapsed){var d=c.startContainer.getParent().$;"COMMENT"===d.nodeName?d._.activate():b.activeComment&&b.activeComment.deactive()}else b.activeComment&&b.activeComment.deactive()}},CKEDITOR.Comments.prototype.ajax=function(b,c){c=c||{};var d={url:Drupal.settings.basePath+"ajax/ckeditor/comment",type:"POST",dataType:"json",data:this.data};c=a.extend(!0,d,c),c.data.action=b,a.ajax(c)},CKEDITOR.Comments.prototype.loadComments=function(){var b=this;if(!b.loaded){b.editor.setReadOnly(!0);var c=a('<div class="loading">Please wait...</div>');b.sidebar.append(c),a(this.editor.document.$).find("body comment").each(function(){var c=a(this),d=a.extend(!0,{inlineElement:c},c.data()),e=new CKEDITOR.Comment(b,d);e.cid||e.remove()}),b.ajax("comment_load",{data:{comments:b.data.cids},success:function(a){b.template=a.template;for(var c=0;c<a.comments.length;c++){var d=new CKEDITOR.Comment(b,a.comments[c]);d.cid&&!b.comments[d.cid]&&b.createComment(d)}},complete:function(){c.remove(),b.editor.setReadOnly(!1)}}),b.loaded=!0}},CKEDITOR.Comments.prototype.createSidebar=function(){var b=this;b.sidebar.length||(b.sidebar=a("<comments/>").addClass("cke-comments-sidebar").attr("data-widget-wrapper","true").appendTo(a(b.editor.document.$).find("html")),a(window).on("resize.cke-comments-sidebar",function(){b.sidebarResize()}),this.editor.on("afterCommandExec",function(a){"maximize"===a.data.name&&b.sidebarResize()}))},CKEDITOR.Comments.prototype.sidebarResize=function(){var b=this,c=a(b.editor.document.$),d=c.find("body");b.sidebar.css("left",(c.find("html").width()-d.outerWidth(!1))/2+d.outerWidth(!1)+20)},CKEDITOR.Comments.prototype.sort=function(){var b,c=a(this.editor.document.$).find("body comment");for(b=0;b<c.length;b++)c[b]._&&c[b]._.sidebarElement.get(0)&&(c[b]._.sidebarElement.get(0).commentIndex=b,this.updateCharacterRange(c[b]));var d=this.sidebar.find("comment");d.length&&(d.sort(function(a,b){return a.commentIndex>b.commentIndex?1:a.commentIndex<b.commentIndex?-1:0}),this.sidebar.append(d))},CKEDITOR.Comments.prototype.updateCharacterRange=function(a){var b=rangy.getSelection(this.editor.document.$),c=this.editor.getSelection().getRanges();this.editor.getSelection().lock(),b.selectAllChildren(a);var d=b.saveCharacterRanges();JSON.stringify(d)!==JSON.stringify(a._.character_range)?(window.console.log('"'+b.toString()+'": new character range'),a._.character_range=d):window.console.log('"'+b.toString()+'": same character range'),this.editor.getSelection().selectRanges(c),this.editor.getSelection().unlock()},CKEDITOR.Comments.prototype.closestComment=function(){var b=this,c=b.editor.getSelection(),d=c.getStartElement(),e=a();return d&&(e=a(d.$).closest("comment"),e.length||(e=a(d.$).find("comment:first")),e.length||(e=a(d.$).parent().find("comment:first"))),d&&e.length||(e=a(b.editor.document.$).find("comment:first")),e.length&&e.get(0)._&&e.get(0)._ instanceof CKEDITOR.Comment?e.get(0)._:!1},CKEDITOR.Comments.prototype.arrangeComments=function(b){var c=this;if(b=b||c.activeComment||c.closestComment(),b&&b.sidebarElement.length){var d,e,f,g,h=b.sidebarElement.prevAll("comment").toArray(),i=b.sidebarElement.nextAll("comment").toArray();d=f=b.sidebarElement.get(0).newTop=b.findTop(),c.sidebar.find("comment").stop(!0);var j=function(){this._.sidebarElement.animate({top:this.newTop+"px"}),delete this.newTop};for(b.sidebarElement.queue("arrangeComments",j);h.length||i.length;)h.length&&(e=h.splice(0,1)[0],d-=a(e).outerHeight(!1)+10,e.newTop=d,a(e).queue("arrangeComments",j)),i.length&&(g=i.splice(0,1)[0],f+=a(g).outerHeight(!1)+10,g.newTop=f,a(g).queue("arrangeComments",j));c.sidebar.find("comment").dequeue("arrangeComments")}},CKEDITOR.Comments.prototype.createComment=function(b,c){var d=this;b=b||{},c=c||!0;var e=d.editor.readOnly;e&&d.editor.setReadOnly(!1);var f=rangy.getSelection(d.editor.document.$);b.character_range?f.restoreCharacterRanges(d.editor.document.getBody().$,b.character_range):(f.expand("word"),f.refresh(),b.character_range=f.saveCharacterRanges());var g=a("<comment/>").html(f.toHtml()).attr("data-cid",b.cid);d.editor.insertElement(new CKEDITOR.dom.element(g.get(0))),b.inlineElement=g,b instanceof CKEDITOR.Comment||(b=new CKEDITOR.Comment(d,b),b.edit()),c&&b.activate(),e&&d.editor.setReadOnly(!0)},CKEDITOR.dtd.comments=1,CKEDITOR.dtd.comment=1;var b=CKEDITOR.dtd.$nonEditable||{};b.comments=1,CKEDITOR.dtd.$nonEditable=b;var c=CKEDITOR.dtd.$nonBodyContent||{};c.comments=1,CKEDITOR.dtd.$nonBodyContent=c;var d=CKEDITOR.dtd.$inline||{};d.comment=1,CKEDITOR.dtd.$inline=d;var e=CKEDITOR.dtd.$editable||{};e.comment=1,CKEDITOR.dtd.$editable=e,CKEDITOR.plugins.add("comments",{init:function(b){var c=this;b.comments=new CKEDITOR.Comments(b),b.comments.enabled&&(b.ui.addButton("comment",{label:"Comment",icon:c.path+"images/comment.png",command:"comment_add"}),b.addCommand("comment_add",{canUndo:!1,modes:{wysiwyg:1},exec:function(){b.comments.createComment()}}),b.on("instanceReady",function(b){var d=b.editor;if(d.comments.enabled){var e=function(){a("<link/>").attr({type:"text/css",rel:"stylesheet",href:c.path+"css/comments.css",media:"screen"}).on("load",function(){d.comments.sidebarResize()}).appendTo(a(d.document.$).find("head"))};e(),d.comments.init(),d.on("mode",function(){"wysiwyg"===d.mode?(e(),d.comments.init()):"source"===d.mode&&(d.comments=new CKEDITOR.Comments(b.editor))})}}),b.on("getData",function(b){for(var c=a("<div/>").html(b.data.dataValue),d=c.find("comment").removeAttr("style").removeAttr("class").toArray(),e=0;e<d.length;e++)d[e]._&&d[e]._ instanceof CKEDITOR.Comment&&!d[e]._.cid&&d[e]._.remove();b.data.dataValue=c.html()}))}})}(jQuery);